---
description: Colyseus multiplayer room schema, messages, and connection patterns
globs: server/src/colyseus/**,client/src/hooks/**
alwaysApply: false
---

# Colyseus Multiplayer Patterns

## Room

- Room name: `"shard"`, one instance per classroom.
- Defined in `server/src/colyseus/rooms/ShardRoom.ts`.
- State schema in `server/src/colyseus/schema/ShardState.ts`.
- **Use `client.send(type, data)` not `this.send(client, type, data)`.** The latter is deprecated in Colyseus 0.16.

## ShardState Schema

- `players`: `MapSchema<PlayerSchema>` keyed by sessionId.
- `tiles`: `MapSchema<TileSchema>` (32x32 world grid).
- `classroomId`: string.

## PlayerSchema Fields

`id`, `gridX`, `gridY`, `stamina`, `maxStamina`, `selectedHotbarSlot`, `lastInteractAtMs`,
`equippedHandItemId`, `equippedHeadItemId` (inventory instance IDs),
`equippedHandDefId`, `equippedHeadDefId` (definition IDs for remote client sprite rendering),
`currentMapKey` (tracks which map the player is on).

## Messages (from `@odyssey/shared` enums)

Both enums are **additive-only** — new message types may be added but existing values must not be renamed or removed.

| Client -> Server | Payload |
|---|---|
| `Move` | `{ gridX, gridY }` |
| `SetMap` | `{ mapKey }` |
| `SelectHotbar` | `{ slotIndex }` |
| `Interact` | `{ target, toolId, actionType, chargeMs }` |
| `OpenContainer` | `{ objectId }` |
| `ClaimContainer` | `{ objectId, nonce }` |
| `EquipItem` | `{ instanceId }` |
| `UnequipItem` | `{ slot }` |
| `DropItem` | `{ instanceId }` — destroys item (Important items rejected) |
| `UseItem` | (planned) |

| Server -> Client | Payload |
|---|---|
| `Notification` | `string` (error/info text) |
| `ContainerContents` | `{ objectId, nonce, items, currencyRewards }` |
| `InventoryUpdate` | `ItemInstance[]` (full snapshot replace) |
| `CurrencyUpdate` | `Record<CurrencyType, number>` (full snapshot) |
| `EquipmentUpdate` | (via schema sync, not message) |

### Adding a New Message

1. Add the value to `ClientMessage` or `ServerMessage` enum in `packages/shared/src/types/messages.ts`.
2. Add a Zod payload schema in `packages/shared/src/validators/`.
3. Register the `onMessage` handler in `ShardRoom.registerMessageHandlers()`.
4. Add the client-side sender in `gameRoomBridge` store and/or listener in `useColyseusRoom`.

## Auth Flow

`ShardRoom.onAuth()` validates JWT via `AuthService` and checks classroom membership via `ClassroomService`.

## onJoin Seeding

On first join (empty inventory), server seeds starter items (axe, watering-can, seeds-bag) and auto-equips axe.
Race condition on reconnect handled by catching duplicate key errors (pg error 23505).

## Client Connection

1. `useColyseusRoom` hook creates Colyseus client and calls `joinOrCreate("shard", { accessToken, classroomId })`.
2. Room ref stored in `gameRoomBridge` Zustand store.
3. `RemotePlayersController` reads room state to reconcile remote player sprites + equipment.
4. Listeners for `Notification`, `ContainerContents`, `InventoryUpdate`, `CurrencyUpdate` registered in `useColyseusRoom`.

## Buffer Size

`Encoder.BUFFER_SIZE` set to 40 KB in `server/src/index.ts` (equipment fields increase encoded state size).
