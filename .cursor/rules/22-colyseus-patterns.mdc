---
description: Colyseus multiplayer room schema, messages, and connection patterns
globs: server/src/colyseus/**,client/src/hooks/**
alwaysApply: false
---

# Colyseus Multiplayer Patterns

## Room

- Room name: `"shard"`, one instance per classroom.
- Defined in `server/src/colyseus/rooms/ShardRoom.ts`.
- State schema in `server/src/colyseus/schema/ShardState.ts`.

## ShardState Schema

- `players`: `MapSchema<PlayerSchema>` keyed by sessionId.
- `tiles`: `MapSchema<TileSchema>` (32x32 world grid).
- `classroomId`: string.

## PlayerSchema Fields

`id`, `gridX`, `gridY`, `stamina`, `maxStamina`, `equippedToolId`,
`selectedHotbarSlot`, `axeLevel`, `wateringCanLevel`, `seedsLevel`, `lastInteractAtMs`.

## Messages (from `@odyssey/shared` enums)

| Client -> Server | Payload |
|------------------|---------|
| `ClientMessage.Move` | `{ gridX, gridY }` |
| `ClientMessage.SelectHotbar` | `{ slot }` |
| `ClientMessage.Interact` | `{ targetX, targetY, toolId, actionType }` |

| Server -> Client | Payload |
|------------------|---------|
| `ServerMessage.Notification` | `{ message }` |
| `ServerMessage.TaskTrigger` | (planned) |
| `ServerMessage.TaskResult` | (planned) |

## Auth Flow

`ShardRoom.onAuth()` validates JWT via `AuthService` and checks classroom membership via `ClassroomService`.

## Client Connection

1. `useColyseusRoom` hook creates Colyseus client and calls `joinOrCreate("shard", { accessToken, classroomId })`.
2. Room ref stored in `gameRoomBridge` Zustand store.
3. `RemotePlayersController` reads room state to reconcile remote player sprites.
