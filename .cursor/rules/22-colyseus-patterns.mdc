---
description: Colyseus multiplayer room schema, messages, and connection patterns
globs: server/src/colyseus/**,client/src/hooks/**
alwaysApply: false
---

# Colyseus Multiplayer Patterns

## Room

- Room name: `"shard"`, one instance per classroom.
- Defined in `server/src/colyseus/rooms/ShardRoom.ts`.
- State schema in `server/src/colyseus/schema/ShardState.ts`.
- **Use `client.send(type, data)` not `this.send(client, type, data)`.** The latter is deprecated in Colyseus 0.16.

## ShardState Schema

- `players`: `MapSchema<PlayerSchema>` keyed by sessionId.
- `tiles`: `MapSchema<TileSchema>` (32x32 world grid).
- `worldObjects`: `MapSchema<WorldObjectSchema>` keyed by objectId (trees, rocks, etc.).
- `classroomId`: string.

## WorldObjectSchema Fields

`objectId`, `definitionId`, `gridX`, `gridY`, `health`, `maxHealth`.

## PlayerSchema Fields

`id`, `gridX`, `gridY`, `stamina`, `maxStamina`, `lastAttackAtMs`,
`equippedHandItemId`, `equippedHeadItemId` (inventory instance IDs),
`equippedHandDefId`, `equippedHeadDefId` (definition IDs for remote client sprite rendering),
`currentMapKey` (tracks which map the player is on).

## Messages (from `@odyssey/shared` enums)

Both enums are **additive-only** — new message types may be added but existing values must not be renamed or removed.

| Client -> Server | Payload |
|---|---|
| `Move` | `{ gridX, gridY }` |
| `SetMap` | `{ mapKey }` |
| `AttackTarget` | `{ gridX, gridY }` — damage world object at tile |
| `OpenContainer` | `{ objectId }` |
| `ClaimContainer` | `{ objectId, nonce }` |
| `EquipItem` | `{ instanceId }` |
| `UnequipItem` | `{ slot }` |
| `DropItem` | `{ instanceId }` — destroys item (Important items rejected) |
| `UseItem` | (planned) |

| Server -> Client | Payload |
|---|---|
| `Notification` | `string` (error/info text) |
| `ContainerContents` | `{ objectId, nonce, items, currencyRewards }` |
| `InventoryUpdate` | `ItemInstance[]` (full snapshot replace) |
| `CurrencyUpdate` | `Record<CurrencyType, number>` (full snapshot) |
| `EquipmentUpdate` | `Record<EquipmentSlot, string \| null>` (full snapshot; sent on join, equip, unequip) |
| `ObjectDamaged` | `{ objectId, newHealth, maxHealth, damage }` (broadcast) |
| `ObjectDestroyed` | `{ objectId }` (broadcast) |

### Adding a New Message

1. Add the value to `ClientMessage` or `ServerMessage` enum in `packages/shared/src/types/messages.ts`.
2. Add a Zod payload schema in `packages/shared/src/validators/`.
3. Register the `onMessage` handler in `ShardRoom.registerMessageHandlers()`.
4. Add the client-side sender in `gameRoomBridge` store and/or listener in `useColyseusRoom`.

## Damage System (Attack Flow)

1. Client sends `ClientMessage.AttackTarget` with `{ gridX, gridY }`.
2. Server looks up world object at target position, validates equipped item has `baseDamage > 0`, checks rate cooldown and range.
3. `damageService.calculateDamage()` computes `baseDamage * highestMatchingTagModifier`.
4. Server applies damage to `WorldObjectSchema.health`, broadcasts `ServerMessage.ObjectDamaged`.
5. If health reaches 0: resolves drops via `LootResolver`, grants items to attacker, broadcasts `ServerMessage.ObjectDestroyed`, removes world object from state.

Key functions in `server/src/colyseus/services/damageService.ts`:
- `calculateDamage(params, targetTags)` — damage with tag multiplier
- `canAttack(lastAttackAtMs, rate, nowMs)` — rate-limit check
- `isInRange(playerX, playerY, targetX, targetY, range)` — Chebyshev distance

## Auth Flow

`ShardRoom.onAuth()` validates JWT via `AuthService` and checks classroom membership via `ClassroomService`.

## onJoin Seeding

On first join (empty inventory), server seeds starter items (axe, watering-can, seeds-bag) and auto-equips axe.
Race condition on reconnect handled by catching duplicate key errors (pg error 23505).

## Client Connection

1. `useColyseusRoom` hook creates Colyseus client and calls `joinOrCreate("shard", { accessToken, classroomId })`.
2. Room ref stored in `gameRoomBridge` Zustand store.
3. `RemotePlayersController` reads room state to reconcile remote player sprites + equipment.
4. Listeners for `Notification`, `ContainerContents`, `InventoryUpdate`, `EquipmentUpdate`, `CurrencyUpdate`, `ObjectDamaged`, `ObjectDestroyed` registered in `useColyseusRoom`.

## Buffer Size

`Encoder.BUFFER_SIZE` set to 40 KB in `server/src/index.ts` (equipment fields increase encoded state size).
