---
description: Server architecture, services, middleware, and DB patterns
globs: server/src/**/*.ts
alwaysApply: false
---

# Server Architecture

## Principles

- Keep route handlers thin; delegate logic to services.
- Services should be pure-ish and unit testable.
- Enforce classroom scoping and role checks in server code.
- Keep Colyseus room handlers lightweight and non-blocking.
- Task validation must remain authoritative server-side.

## Route Files (`api/routes/`)

- `auth.ts` — `POST /auth/register`, `POST /auth/login`, `GET /auth/registration-status`.
- `classroom.ts` — CRUD + student summaries + economy views (teacher-only).
- `invite.ts` — `POST /invites` (create), `GET /invites/:token` (validate), `POST /invites/:token/accept`.
- `task.ts` — `POST /tasks/:taskId/submit` (authenticated, classroom-scoped).
- New route files follow the same pattern: thin handlers, Zod validation at boundaries, service delegation. Registered via `registerRoutes()` in `api/routes.ts`.

## Middleware (`api/middleware/`)

- `auth.ts` — Bearer JWT validation, attaches `authUser` to request.
- `role.ts` — `requireRole("teacher")` / `requireRole("student")`.

## Services

- `AuthService` — scrypt password hashing, JWT issue/verify, user lookup.
- `ClassroomService` — create, list, enroll; membership-based visibility for students.
- `TaskService` — loads task JSON from `content/`, executes validator from registry.
- `InviteService` — classroom invites with email delivery (SES) and student auto-enrollment.
- `EmailService` — AWS SES integration for invite emails.

### Inventory Services (`server/src/inventory/`)

- `InventoryService` — CRUD for `player_inventory` (getInventory, addItems, removeItem, moveItem, extractItem, insertItem).
- `EquipmentService` — equip/unequip by slot (`hand`, `head`); references inventory instance IDs.
- `CurrencyService` — getBalances, addCurrency, spendCurrency for `player_currency`.
- `ContainerService` — stateful open/claim with nonce-based idempotency via `container_claims` table. Supports legacy `loot[]` and new `drops[]` (loot table) resolution paths.
- `ItemDefinitionLoader` — loads + caches `content/items/*.item.json` at startup.
- `ContainerDefinitionLoader` — loads + caches `content/containers/*.container.json` at startup.
- `LootTableLoader` — loads + caches `content/loot-tables/*.loot-table.json` at startup.
- `LootResolver` — resolves loot drops from tiered/weighted/fixed/uniform methods with tag and table references.
- `ItemActionResolver` — resolves available actions per item and dispatches to component hooks.

### Component Registry (`server/src/inventory/components/`)

Registry pattern (like task-validators). Current components: `Equippable`, `Cosmetic`, `Readable`, `Container`, `Destroyable`.
Each component defines a Zod params schema, getActions, and lifecycle hooks (onEquip, onUnequip, onUse).
New component types are added by creating a module in this directory and registering it in `ComponentRegistry`.

### Colyseus Services (`server/src/colyseus/services/`)

- `damageService.ts` — `calculateDamage()`, `canAttack()`, `isInRange()` for the attack/damage system.
- `movementService.test.ts` — movement validation tests.

### Room Utilities (`server/src/colyseus/rooms/`)

- `inventoryTreeUtils.ts` — pure functions for searching nested `ItemInstance` trees.
- `roomServices.ts` — `RoomServices` interface, `JoinAuthContext`, and helper functions for syncing equipment state between DB and Colyseus schema.

## Database (`db/postgres.ts`)

Bootstrap migration creates: `app_users`, `classrooms`, `classroom_memberships`,
`player_currency`, `player_inventory`, `player_equipment`, `container_claims`.
No dedicated migration tooling yet — SQL runs in `PostgresDatabase.migrate()`.

Key inventory constraints:
- `player_inventory.quantity CHECK (quantity >= 1)` — zero-quantity rows must be deleted.
- `UNIQUE (user_id, slot_index) WHERE slot_index IS NOT NULL` — partial unique for inventory slots.
- `player_currency` uses column-per-type (coins, museum_points) with `CHECK (>= 0)`.

## Colyseus Integration

Fastify + Colyseus share the same HTTP server in `index.ts`.
Room `"shard"` registered via `gameServer.define()`. See `22-colyseus-patterns` for details.
Services injected into `ShardRoom` via `ShardRoom.configureServices()` in `index.ts`.
