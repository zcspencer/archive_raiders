---
description: Phaser scene hierarchy, game systems, entities, and map pipeline
globs: client/src/game/**
alwaysApply: false
---

# Phaser Game Systems

## Scene Lifecycle

`BootScene` (loads assets, parses maps, stores in registry) -> `VillageScene` / `EldersHouseScene`.

## Scene Hierarchy

- `GridMapScene` (abstract base): map rendering, entity spawning, grid movement, interaction, camera follow.
- `VillageScene extends GridMapScene`: adds `RemotePlayersController` for multiplayer.
- `EldersHouseScene extends GridMapScene`: interior scene, no multiplayer.

## Systems (`game/systems/`)

| System | Responsibility |
|--------|---------------|
| `GameplayInput` | WASD + X key bindings; blocks when form/dialogue/chest active |
| `gridMovement` | Tile-by-tile movement with tweens and collision checks |
| `InteractionHandler` | Routes X-press to NPC dialogue, chest open, or door transition |
| `interactionDetection` | Finds adjacent entity player is facing (NPCs prioritized) |
| `RemotePlayersController` | Diffs Colyseus room state to create/update/remove remote sprites |

## Entities (`game/entities/`)

- `Npc`: name label, "X to talk" prompt, `isPlayerAdjacent()`, `isPlayerFacing()`.
- `InteractableObject`: kind-based (chest, door, artifact, sign), colored by kind, prompt label.

## Map Pipeline

Tiled JSON (`content/maps/`) -> `TileMapManager.parseMap()` -> `ParsedMap` -> Phaser registry.
`ParsedMap` contains: ground tiles, collision grid, NPC placements, object placements, spawn point.

## Rendering

All textures are procedurally generated (no external art assets yet):
- `tileRenderer.ts`: colored tile atlas from tile IDs.
- `playerSprite.ts`: 4-direction spritesheet with walk animations.

## Input Blocking

`GameplayInput.isBlocked()` checks: form focus (`formFocus.ts`), dialogue open, chest open, input mode.
