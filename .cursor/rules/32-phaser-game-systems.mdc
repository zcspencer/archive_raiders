---
description: Phaser scene hierarchy, game systems, entities, and map pipeline
globs: client/src/game/**
alwaysApply: false
---

# Phaser Game Systems

## Scene Lifecycle

`BootScene` (loads assets, parses all maps, stores in registry) -> initial scene (currently `VillageScene`).

## Scene Hierarchy

- `GridMapScene` (abstract base): map rendering, entity spawning, grid movement, interaction, camera follow, equipped item sprite sync.
- Concrete scenes extend `GridMapScene`. Current scenes include `VillageScene`, `EldersHouseScene`, `MosslightCottageScene`, `TimberNookScene`. Additional `GridMapScene` subclasses are added as new maps are built.
- Multiplayer scenes (e.g. `VillageScene`) add `RemotePlayersController` for Colyseus state sync.
- Interior/single-player scenes (e.g. `EldersHouseScene`) omit remote players.

### Adding a New Scene

1. Create a Tiled JSON map in `content/maps/`.
2. Add a `GridMapScene` subclass in `client/src/game/scenes/`.
3. Register the scene in `client/src/game/config.ts`.
4. Add door/transition entries in `InteractionHandler` if reachable via doors.

## Systems (`game/systems/`)

| System | Responsibility |
|--------|---------------|
| `GameplayInput` | WASD + X key bindings; blocks when form/dialogue/container active |
| `gridMovement` | Tile-by-tile movement with tweens and collision checks |
| `InteractionHandler` | Routes X-press to NPC dialogue, container open, door transition, or challenge |
| `interactionDetection` | Finds adjacent entity player is facing (NPCs prioritized) |
| `RemotePlayersController` | Diffs Colyseus room state; creates/updates/removes remote sprites + equipment placeholders |

## Entities (`game/entities/`)

- `Npc`: name label, "X to talk" prompt, `isPlayerAdjacent()`, `isPlayerFacing()`.
- `InteractableObject`: kind-based (chest, door, artifact, sign, etc.), colored by kind, prompt label. New interactable kinds are added by extending `InteractableObjectKind` in shared types.

## Rendering (`game/rendering/`)

All textures are procedurally generated (no external art assets yet):
- `tileRenderer.ts`: colored tile atlas from tile IDs.
- `playerSprite.ts`: 4-direction spritesheet with walk animations. `animKeyForFacing()`, `idleFrameForFacing()`.
- `equippedItemSprite.ts`: `EquippedItemSpriteController` â€” manages child placeholder rectangles for hand/head equipment. Uses `EQUIPMENT_ANCHORS` from `@odyssey/shared` for offset/depth per facing direction. `sync()` called each frame from `updatePlayerAnimation()`.

## Map Pipeline

Tiled JSON (`content/maps/`) -> `TileMapManager.parseMap()` -> `ParsedMap` -> Phaser registry.
`ParsedMap` contains: ground tiles, collision grid, NPC placements, object placements, spawn point.

## Input Blocking

`GameplayInput.isBlocked()` checks: form focus (`formFocus.ts`), dialogue open, container open, challenge active, input mode.
