---
description: Phaser scene hierarchy, game systems, entities, and map pipeline
globs: client/src/game/**
alwaysApply: false
---

# Phaser Game Systems

## Scene Lifecycle

`BootScene` (preloads tileset, parses Tiled maps, stores in registry) -> initial scene (`TiledMapScene`).

## Scene Hierarchy

- `TiledMapScene`: generic scene that loads any Tiled map. Handles map rendering, entity spawning, grid movement, interaction, camera follow, equipped item sprite sync, and `RemotePlayersController` for Colyseus state sync.
- Transitions are data-driven via object properties (`destination_map`, `destination_spawn`).

### Adding a New Map

1. Create/export a Tiled JSON map to `content/maps/` (source of truth: `tiled_maps/`).
2. Add the map import and `parseTiledMap()` registration in `BootScene`.
3. Add transition objects with `destination_map` and `destination_spawn` for doors/portals.

## Systems (`game/systems/`)

| System | Responsibility |
|--------|---------------|
| `GameplayInput` | WASD + X key bindings; blocks when form/dialogue/container active |
| `gridMovement` | Tile-by-tile movement with tweens and collision checks |
| `InteractionHandler` | Routes X-press to NPC dialogue, container open, door transition, or challenge |
| `interactionDetection` | Finds adjacent entity player is facing (NPCs prioritized) |
| `RemotePlayersController` | Diffs Colyseus room state; creates/updates/removes remote sprites + equipment placeholders |
| `WorldObjectsController` | Reconciles Colyseus `worldObjects` with Phaser sprites; filters by `currentMapKey`; manages health bars and collision |

## Entities (`game/entities/`)

- `Npc`: name label, "X to talk" prompt, `isPlayerAdjacent()`, `isPlayerFacing()`.
- `InteractableObject`: kind-based (chest, door, artifact, sign, etc.), colored by kind, prompt label. New interactable kinds are added by extending `InteractableObjectKind` in shared types.

## Rendering (`game/rendering/`, `game/map/`)

- `tiledTileRenderer.ts`: renders tile layers (ground, detail_down, detail_up) from real tileset spritesheet.
- `playerSprite.ts`: 4-direction spritesheet with walk animations. `animKeyForFacing()`, `idleFrameForFacing()`.
- `equippedItemSprite.ts`: `EquippedItemSpriteController` â€” manages child placeholder rectangles for hand/head equipment. Uses `EQUIPMENT_ANCHORS` from `@odyssey/shared` for offset/depth per facing direction. `sync()` called each frame from `updatePlayerAnimation()`.

## Map Pipeline

Tiled JSON (`content/maps/`) -> `TiledMapParser.parseTiledMap()` -> `ParsedTiledMap` -> Phaser registry.
`ParsedTiledMap` contains: ground/detail tile layers, collision grid (rasterized from polygon/ellipse objects or tile layer), named spawns, NPCs, interactables, transitions. Uses snake_case properties (`npc_id`, `object_id`, `destination_map`, `destination_spawn`).

## Input Blocking

`GameplayInput.isBlocked()` checks: form focus (`formFocus.ts`), dialogue open, container open, challenge active, input mode.
